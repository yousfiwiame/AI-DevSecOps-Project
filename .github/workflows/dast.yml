name: DAST Security Scan with OWASP ZAP

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  dast-scan:
    name: Dynamic Application Security Testing (DAST) with OWASP ZAP
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Prepare reports directory
      run: mkdir -p reports
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Start Flask Application
      run: |
        echo "Starting Flask application..."
        python app.py &
        sleep 10
        for i in {1..30}; do
          if curl -sf http://localhost:5000 > /dev/null 2>&1; then
            echo "Application is running on http://localhost:5000"
            break
          fi
          echo "Waiting for app... attempt $i/30"
          sleep 2
        done
        curl -v http://localhost:5000
      env:
        FLASK_ENV: testing
        SECRET_KEY: test-secret-key
    
    - name: Run OWASP ZAP Baseline Scan
      run: |
        echo "Running OWASP ZAP Baseline scan..."
        docker run --network="host" -v $(pwd)/reports:/zap/wrk/:rw \
          ghcr.io/zaproxy/zaproxy:stable \
          zap-baseline.py -t http://localhost:5000 \
          -r zap-baseline-report.html \
          -J zap-baseline-report.json \
          -w zap-baseline-report.md || true
        echo "Baseline scan completed"
    
    - name: Run OWASP ZAP Full Scan
      run: |
        echo "Running OWASP ZAP Full scan..."
        docker run --network="host" -v $(pwd)/reports:/zap/wrk/:rw \
          ghcr.io/zaproxy/zaproxy:stable \
          zap-full-scan.py -t http://localhost:5000 \
          -r zap-full-scan-report.html \
          -J zap-full-scan-report.json \
          -w zap-full-scan-report.md || true
        echo "Full scan completed"
    
    - name: Generate DAST Summary Report
      run: |
        echo "Generating DAST summary..."
        cat > reports/dast-summary.txt << 'EOF'
        ================================
        OWASP ZAP DAST Scan Summary
        ================================
        
        Baseline Scan: Completed
        Full Scan: Completed
        
        Reports generated:
        - zap-baseline-report.html
        - zap-baseline-report.json
        - zap-baseline-report.md
        - zap-full-scan-report.html
        - zap-full-scan-report.json
        - zap-full-scan-report.md
        
        Check the artifacts for detailed vulnerability reports.
        EOF
        cat reports/dast-summary.txt
    
    - name: Upload DAST reports
      uses: actions/upload-artifact@v4
      with:
        name: dast-reports
        path: |
          reports/zap-baseline-report.*
          reports/zap-full-scan-report.*
          reports/dast-summary.txt
    
    - name: Display DAST Results
      run: |
        echo "## DAST Scan Results"
        echo "### ZAP Baseline Scan Results:"
        if [ -f reports/zap-baseline-report.md ]; then
          cat reports/zap-baseline-report.md
        else
          echo "Baseline scan report not found"
        fi
        
        echo ""
        echo "### ZAP Full Scan Results:"
        if [ -f reports/zap-full-scan-report.md ]; then
          cat reports/zap-full-scan-report.md
        else
          echo "Full scan report not found"
        fi