name: DAST

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 1'

jobs:
  dast-scan:
    name: DAST Security Scan
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
      security-events: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Start Flask Application
      run: |
        python app.py &
        sleep 10
        for i in {1..30}; do
          if curl -sf http://localhost:5000 > /dev/null 2>&1; then
            echo "Application is running"
            break
          fi
          echo "Waiting for app... attempt $i/30"
          sleep 2
        done
        curl -v http://localhost:5000
      env:
        FLASK_ENV: testing
        SECRET_KEY: test-secret-key
    
    - name: Run OWASP ZAP Baseline Scan
      uses: zaproxy/action-baseline@v0.12.0
      with:
        target: 'http://localhost:5000'
        rules_file_name: '.zap/rules.tsv'
        cmd_options: '-a'
        allow_issue_writing: false
        fail_action: false
        issue_title: false
        token: ''
    
    - name: Upload ZAP Baseline Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: zap-baseline-report
        path: |
          report_html.html
          report_md.md
          report_json.json
        if-no-files-found: warn
    
    - name: Run OWASP ZAP Full Scan
      uses: zaproxy/action-full-scan@v0.12.0
      with:
        target: 'http://localhost:5000'
        rules_file_name: '.zap/rules.tsv'
        cmd_options: '-a'
        allow_issue_writing: false
        fail_action: false
        issue_title: false
        token: ''
    
    - name: Upload ZAP Full Scan Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: zap-full-scan-report
        path: |
          report_html.html
          report_md.md
          report_json.json
        if-no-files-found: warn
    
    - name: DAST Summary
      if: always()
      run: |
        echo "DAST scanning completed"
        echo "Check uploaded artifacts for detailed reports"