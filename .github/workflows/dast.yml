name: DAST Security Scan with OWASP ZAP

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  dast-scan:
    name: Dynamic Application Security Testing (DAST) with OWASP ZAP
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Prepare reports directory
      run: mkdir -p reports
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        sudo apt-get update && sudo apt-get install -y jq
    
    - name: Start Flask Application
      run: |
        echo "Starting Flask application..."
        python app.py &
        sleep 10
        for i in {1..30}; do
          if curl -sf http://localhost:5000 > /dev/null 2>&1; then
            echo "Application is running on http://localhost:5000"
            break
          fi
          echo "Waiting for app... attempt $i/30"
          sleep 2
        done
        curl -v http://localhost:5000
      env:
        FLASK_ENV: testing
        SECRET_KEY: test-secret-key
    
    - name: Run OWASP ZAP Baseline Scan
      run: |
        echo "Running OWASP ZAP Baseline scan..."
        docker run --network="host" -v $(pwd)/reports:/zap/wrk/:rw \
          ghcr.io/zaproxy/zaproxy:stable \
          zap-baseline.py -t http://localhost:5000 \
          -r zap-baseline-report.html \
          -J zap-baseline-report.json \
          -w zap-baseline-report.md || true
        
        echo "Checking if baseline reports were generated..."
        ls -lah reports/
        
        if [ -f reports/zap-baseline-report.json ]; then
          echo "Baseline JSON report found"
          echo "First 500 chars of JSON:"
          head -c 500 reports/zap-baseline-report.json
        else
          echo "WARNING: Baseline JSON report not found!"
        fi
    
    - name: Run OWASP ZAP Full Scan
      run: |
        echo "Running OWASP ZAP Full scan..."
        docker run --network="host" -v $(pwd)/reports:/zap/wrk/:rw \
          ghcr.io/zaproxy/zaproxy:stable \
          zap-full-scan.py -t http://localhost:5000 \
          -r zap-full-scan-report.html \
          -J zap-full-scan-report.json \
          -w zap-full-scan-report.md || true
        
        echo "Checking if full scan reports were generated..."
        ls -lah reports/
        
        if [ -f reports/zap-full-scan-report.json ]; then
          echo "Full scan JSON report found"
          echo "First 500 chars of JSON:"
          head -c 500 reports/zap-full-scan-report.json
        else
          echo "WARNING: Full scan JSON report not found!"
        fi
    
    - name: Generate DAST Summary Report
      run: |
        echo "Generating DAST summary from scan results..."
        
        # Initialize counters
        BASELINE_HIGH=0
        BASELINE_MEDIUM=0
        BASELINE_LOW=0
        BASELINE_INFO=0
        FULL_HIGH=0
        FULL_MEDIUM=0
        FULL_LOW=0
        FULL_INFO=0
        
        # Parse baseline scan results with better error handling
        if [ -f reports/zap-baseline-report.json ]; then
          echo "Parsing baseline report..."
          
          # Check if file has valid JSON
          if jq empty reports/zap-baseline-report.json 2>/dev/null; then
            echo "Valid JSON detected"
            
            # Try different JSON structures
            if jq -e '.site' reports/zap-baseline-report.json >/dev/null 2>&1; then
              BASELINE_HIGH=$(jq '[.site[0].alerts[]? | select(.riskcode == "3")] | length' reports/zap-baseline-report.json 2>/dev/null || echo 0)
              BASELINE_MEDIUM=$(jq '[.site[0].alerts[]? | select(.riskcode == "2")] | length' reports/zap-baseline-report.json 2>/dev/null || echo 0)
              BASELINE_LOW=$(jq '[.site[0].alerts[]? | select(.riskcode == "1")] | length' reports/zap-baseline-report.json 2>/dev/null || echo 0)
              BASELINE_INFO=$(jq '[.site[0].alerts[]? | select(.riskcode == "0")] | length' reports/zap-baseline-report.json 2>/dev/null || echo 0)
            fi
          else
            echo "Invalid JSON in baseline report"
          fi
        fi
        
        # Parse full scan results with better error handling
        if [ -f reports/zap-full-scan-report.json ]; then
          echo "Parsing full scan report..."
          
          # Check if file has valid JSON
          if jq empty reports/zap-full-scan-report.json 2>/dev/null; then
            echo "Valid JSON detected"
            
            # Try different JSON structures
            if jq -e '.site' reports/zap-full-scan-report.json >/dev/null 2>&1; then
              FULL_HIGH=$(jq '[.site[0].alerts[]? | select(.riskcode == "3")] | length' reports/zap-full-scan-report.json 2>/dev/null || echo 0)
              FULL_MEDIUM=$(jq '[.site[0].alerts[]? | select(.riskcode == "2")] | length' reports/zap-full-scan-report.json 2>/dev/null || echo 0)
              FULL_LOW=$(jq '[.site[0].alerts[]? | select(.riskcode == "1")] | length' reports/zap-full-scan-report.json 2>/dev/null || echo 0)
              FULL_INFO=$(jq '[.site[0].alerts[]? | select(.riskcode == "0")] | length' reports/zap-full-scan-report.json 2>/dev/null || echo 0)
            fi
          else
            echo "Invalid JSON in full scan report"
          fi
        fi
        
        BASELINE_TOTAL=$((BASELINE_HIGH + BASELINE_MEDIUM + BASELINE_LOW + BASELINE_INFO))
        FULL_TOTAL=$((FULL_HIGH + FULL_MEDIUM + FULL_LOW + FULL_INFO))
        
        echo "Baseline totals: HIGH=$BASELINE_HIGH MEDIUM=$BASELINE_MEDIUM LOW=$BASELINE_LOW INFO=$BASELINE_INFO"
        echo "Full scan totals: HIGH=$FULL_HIGH MEDIUM=$FULL_MEDIUM LOW=$FULL_LOW INFO=$FULL_INFO"
        
        # Create text summary
        cat > reports/dast-summary.txt << EOF
        ================================================================
        OWASP ZAP DAST Security Scan Summary
        ================================================================
        
        BASELINE SCAN: ${BASELINE_TOTAL} issues found
        - High:     ${BASELINE_HIGH}
        - Medium:   ${BASELINE_MEDIUM}
        - Low:      ${BASELINE_LOW}
        - Info:     ${BASELINE_INFO}
        
        FULL SCAN: ${FULL_TOTAL} issues found
        - High:     ${FULL_HIGH}
        - Medium:   ${FULL_MEDIUM}
        - Low:      ${FULL_LOW}
        - Info:     ${FULL_INFO}
        ================================================================
        EOF
        
        cat reports/dast-summary.txt
        
        # Create GitHub Step Summary
        echo "# ðŸ”’ OWASP ZAP DAST Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Total issues found: $FULL_TOTAL" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Severity Breakdown (Full Scan):" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸ”´ HIGH**: $FULL_HIGH" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸŸ  MEDIUM**: $FULL_MEDIUM" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸŸ¡ LOW**: $FULL_LOW" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸ”µ INFO**: $FULL_INFO" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Add top vulnerabilities to summary
        echo "### ðŸš¨ High & Medium Severity Issues:" >> $GITHUB_STEP_SUMMARY
        if [ -f reports/zap-full-scan-report.json ] && jq -e '.site[0].alerts' reports/zap-full-scan-report.json >/dev/null 2>&1; then
          ISSUES_FOUND=$(jq -r '.site[0].alerts[]? | select(.riskcode == "3" or .riskcode == "2") | "- **\(.risk)** \(.name) â†’ \(.instances[0].uri // "Multiple locations")"' reports/zap-full-scan-report.json 2>/dev/null)
          if [ -n "$ISSUES_FOUND" ]; then
            echo "$ISSUES_FOUND" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No high/medium issues found" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "_Unable to parse vulnerability details_" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Š **Download the full reports from artifacts for detailed information**" >> $GITHUB_STEP_SUMMARY
    
    - name: Upload DAST reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: dast-reports
        path: |
          reports/
    
    - name: Display DAST Results
      if: always()
      run: |
        echo "## DAST Scan Completed"
        cat reports/dast-summary.txt